<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>For A.P - Merry Christmas</title>
    <meta name="description" content="A special Christmas gift">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Eater&family=Chiron+Sung+HK&family=Marck+Script&display=swap" rel="stylesheet">
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
      body {
        margin: 0;
        overflow: hidden;
        background-color: #050505;
        touch-action: manipulation;
      }
      canvas {
        display: block;
      }
      
      /* Custom Animations */
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
      }
      @keyframes caret-blink { 50% { border-color: transparent; } }

      .typing {
        border-right: 2px solid #b476f5;
        white-space: pre-wrap;
        animation: caret-blink .70s steps(1) infinite;
      }
      .animate-shake {
        animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both;
      }
      .scrollbar-hide::-webkit-scrollbar {
          display: none;
      }
      .scrollbar-hide {
          -ms-overflow-style: none;
          scrollbar-width: none;
      }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- COMMON SETUP ---
        const { useState, useEffect, useRef } = React;

        // --- 1. SNOW OVERLAY COMPONENT ---
        const SnowOverlay = () => {
            const canvasRef = useRef(null);

            useEffect(() => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                if (!ctx) return;

                const handleResize = () => {
                    canvas.width = window.innerWidth;
                    canvas.height = window.innerHeight;
                };
                window.addEventListener('resize', handleResize);
                handleResize();

                const SNOW_COUNT = 150;
                const snow = [];
                for (let i = 0; i < SNOW_COUNT; i++) {
                    snow.push({
                        x: Math.random() * canvas.width,
                        y: Math.random() * canvas.height,
                        vy: 1 + Math.random() * 2,
                        radius: 1 + Math.random() * 3,
                        alpha: 0.3 + Math.random() * 0.6,
                    });
                }

                let animationFrameId;
                const render = () => {
                    const { width, height } = canvas;
                    ctx.clearRect(0, 0, width, height);
                    const time = Date.now();
                    
                    // Simulated Beat
                    const beatWave = Math.sin(time / 300);
                    let beatMultiplier = 1;
                    if (beatWave > 0.8) {
                        beatMultiplier = 1 + (beatWave - 0.8) * 5;
                    }

                    ctx.fillStyle = "#FFFFFF";
                    snow.forEach(s => {
                        const currentSpeed = s.vy * beatMultiplier;
                        s.y += currentSpeed;
                        s.x += Math.sin(time * 0.001 + s.y * 0.01) * (0.5 * beatMultiplier);
                        if (s.y > height) { s.y = -10; s.x = Math.random() * width; }
                        if (s.x > width) s.x = 0;
                        if (s.x < 0) s.x = width;

                        ctx.globalAlpha = s.alpha;
                        ctx.beginPath();
                        const radiusPulse = beatMultiplier > 1.2 ? s.radius * 1.1 : s.radius;
                        ctx.arc(s.x, s.y, radiusPulse, 0, Math.PI * 2);
                        ctx.fill();
                    });
                    ctx.globalAlpha = 1;
                    animationFrameId = requestAnimationFrame(render);
                };
                render();
                return () => {
                    window.removeEventListener('resize', handleResize);
                    cancelAnimationFrame(animationFrameId);
                };
            }, []);

            return <canvas ref={canvasRef} className="fixed top-0 left-0 w-full h-full pointer-events-none z-[60]" />;
        };

        // --- 2. DATE REVEAL COMPONENT ---
        const DateReveal = ({ onComplete }) => {
            const canvasRef = useRef(null);
            useEffect(() => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                if (!ctx) return;
                
                const resize = () => {
                     canvas.width = window.innerWidth;
                     canvas.height = window.innerHeight;
                }
                window.addEventListener('resize', resize);
                resize();

                const getParticlesForText = (text, fontSize) => {
                    const tempCanvas = document.createElement('canvas');
                    const tCtx = tempCanvas.getContext('2d');
                    tempCanvas.width = window.innerWidth;
                    tempCanvas.height = window.innerHeight;
                    tCtx.fillStyle = 'white';
                    tCtx.font = `bold ${fontSize}px 'Chiron Sung HK', sans-serif`;
                    tCtx.textAlign = 'center';
                    tCtx.textBaseline = 'middle';
                    tCtx.fillText(text, tempCanvas.width / 2, tempCanvas.height / 2);
                    
                    const imageData = tCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
                    const data = imageData.data;
                    const step = 6; 
                    const newParticles = [];
                    for (let y = 0; y < tempCanvas.height; y += step) {
                        for (let x = 0; x < tempCanvas.width; x += step) {
                            const index = (y * tempCanvas.width + x) * 4;
                            if (data[index + 3] > 128) {
                                const angle = Math.random() * Math.PI * 2;
                                const radius = Math.random() * 300 + 100;
                                newParticles.push({
                                    originX: x, originY: y,
                                    brokenX: x + Math.cos(angle) * radius,
                                    brokenY: y + Math.sin(angle) * radius,
                                    color: '#D697FF'
                                });
                            }
                        }
                    }
                    return newParticles;
                };

                const isMobile = window.innerWidth < 768;
                const particlesDate = getParticlesForText("25.12.2025", isMobile ? 60 : 120);
                const particlesXmas = getParticlesForText("Merry Christmas", isMobile ? 45 : 100);

                let particles = particlesDate;
                let startTime = Date.now();
                let phase = 0;
                const PHASE_DURATIONS = [2000, 2500, 1500, 2000, 2500];
                let animationFrameId;
                
                const lerp = (a, b, t) => a + (b - a) * t;
                const easeOutCubic = (t) => 1 - Math.pow(1 - t, 3);
                const easeInCubic = (t) => t * t * t;

                const render = () => {
                    const elapsed = Date.now() - startTime;
                    ctx.fillStyle = 'black';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    let progress = 0;

                    if (phase === 0) {
                        progress = 1 - easeOutCubic(Math.min(elapsed / PHASE_DURATIONS[0], 1));
                        if (elapsed >= PHASE_DURATIONS[0]) { phase = 1; startTime = Date.now(); }
                    } else if (phase === 1) {
                        progress = 0;
                        if (elapsed >= PHASE_DURATIONS[1]) { phase = 2; startTime = Date.now(); }
                    } else if (phase === 2) {
                        progress = easeInCubic(Math.min(elapsed / PHASE_DURATIONS[2], 1));
                        if (elapsed >= PHASE_DURATIONS[2]) { phase = 3; startTime = Date.now(); particles = particlesXmas; }
                    } else if (phase === 3) {
                        progress = 1 - easeOutCubic(Math.min(elapsed / PHASE_DURATIONS[3], 1));
                        if (elapsed >= PHASE_DURATIONS[3]) { phase = 4; startTime = Date.now(); }
                    } else if (phase === 4) {
                        progress = 0;
                        if (elapsed >= PHASE_DURATIONS[4]) { phase = 5; }
                    } else if (phase === 5) {
                        onComplete();
                        return;
                    }

                    particles.forEach(p => {
                        const cx = lerp(p.originX, p.brokenX, progress);
                        const cy = lerp(p.originY, p.brokenY, progress);
                        ctx.fillStyle = p.color;
                        ctx.fillRect(cx, cy, 2, 2);
                    });
                    animationFrameId = requestAnimationFrame(render);
                };
                render();
                return () => {
                    window.removeEventListener('resize', resize);
                    cancelAnimationFrame(animationFrameId);
                }
            }, [onComplete]);

            return (
                <div className="absolute inset-0 bg-black z-40">
                    <canvas ref={canvasRef} className="block w-full h-full" />
                </div>
            );
        };

        // --- 3. CHRISTMAS SCENE (TREES) COMPONENT ---
        const CYAN_PALETTE = ['#E0FFFF', '#00FFFF', '#87CEFA', '#FFFFFF', '#B0E0E6', '#F0FFFF'];
        const PINK_PALETTE = ['#FFC0CB', '#FF69B4', '#FF1493', '#FFFFFF', '#FFB6C1', '#EE82EE'];

        const ChristmasScene = () => {
            const canvasRef = useRef(null);
            const [windowSize, setWindowSize] = useState({ width: window.innerWidth, height: window.innerHeight });

            useEffect(() => {
                const handleResize = () => setWindowSize({ width: window.innerWidth, height: window.innerHeight });
                window.addEventListener('resize', handleResize);
                return () => window.removeEventListener('resize', handleResize);
            }, []);

            useEffect(() => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                const ctx = canvas.getContext('2d');
                if (!ctx) return;
                canvas.width = windowSize.width;
                canvas.height = windowSize.height;

                const TREE_PARTICLE_COUNT = 1800;
                const GROUND_PARTICLE_COUNT = 800;
                const SNOW_COUNT = 100;

                const createTree = (palette) => {
                    const p = [];
                    for(let i=0; i<TREE_PARTICLE_COUNT; i++) {
                        p.push({
                            heightPercent: Math.random(),
                            angle: Math.random() * Math.PI * 2,
                            radiusOffset: 0.2 + 0.8 * Math.pow(Math.random(), 0.8),
                            speed: 0.0001 + Math.random() * 0.0005,
                            rotationSpeed: 0.005 + Math.random() * 0.005,
                            color: Math.random() > 0.7 ? '#FFFFFF' : palette[Math.floor(Math.random() * palette.length)],
                            baseSize: Math.random() * 1.3 + 0.4
                        });
                    }
                    return p;
                };

                const createGround = (palette) => {
                    const p = [];
                    const rings = 12;
                    for(let i=0; i<GROUND_PARTICLE_COUNT; i++) {
                        const ringIndex = Math.floor(Math.random() * rings);
                        const r = 100 + ringIndex * 50 + (Math.random() - 0.5) * 40;
                        const angle = Math.random() * Math.PI * 2;
                        p.push({
                            x: Math.cos(angle) * r,
                            z: Math.sin(angle) * r,
                            angle, radius: r,
                            color: Math.random() > 0.9 ? '#FFFFFF' : palette[Math.floor(Math.random() * palette.length)],
                            size: Math.random() * 1.2 + 0.5,
                            blinkSpeed: 0.01 + Math.random() * 0.03,
                            blinkOffset: Math.random() * Math.PI * 2
                        });
                    }
                    return p;
                };

                const leftTree = createTree(CYAN_PALETTE);
                const rightTree = createTree(PINK_PALETTE);
                const leftGround = createGround(CYAN_PALETTE);
                const rightGround = createGround(PINK_PALETTE);
                const snow = [];
                for(let i=0; i<SNOW_COUNT; i++) {
                    snow.push({
                        x: Math.random() * canvas.width,
                        y: Math.random() * canvas.height,
                        vy: 0.5 + Math.random() * 2.5,
                        radius: 0.5 + Math.random() * 2,
                        alpha: 0.2 + Math.random() * 0.6
                    });
                }

                const processTree = (particles, cx, baseY, maxW, maxH) => {
                    particles.forEach(p => {
                        p.heightPercent += p.speed;
                        p.angle += p.rotationSpeed;
                        if(p.heightPercent > 1) { p.heightPercent = 0; p.angle = Math.random()*Math.PI*2; }

                        const taper = Math.pow(1 - p.heightPercent, 1.1);
                        const tiers = 1 - 0.3 * (0.5 + 0.5 * Math.sin(p.heightPercent * Math.PI * 12));
                        const branchShape = 0.8 + 0.2 * Math.cos(p.angle * 5 + p.heightPercent * 5);
                        const currentRadius = (maxW / 2) * taper * tiers * branchShape * p.radiusOffset;
                        
                        const x3d = Math.cos(p.angle) * currentRadius;
                        const z3d = Math.sin(p.angle) * currentRadius;
                        const y3d = p.heightPercent * maxH;
                        
                        p.screenX = cx + x3d;
                        p.screenY = baseY - y3d;
                        p.zDepth = z3d;
                        
                        const depthNorm = z3d / (maxW/2);
                        p.alpha = 0.4 + (depthNorm + 1) * 0.35;
                        p.scale = 0.6 + (depthNorm + 1) * 0.5;
                    });
                    
                    particles.sort((a,b) => a.zDepth - b.zDepth);
                    
                    particles.forEach(p => {
                        ctx.globalAlpha = p.alpha;
                        ctx.fillStyle = p.color;
                        const ds = p.baseSize * p.scale;
                        if(p.scale > 0.9) { ctx.shadowBlur = ds*5; ctx.shadowColor = p.color; } else { ctx.shadowBlur = 0; }
                        ctx.beginPath();
                        ctx.arc(p.screenX, p.screenY, ds, 0, Math.PI*2);
                        ctx.fill();
                    });
                    ctx.shadowBlur = 0;
                    ctx.globalAlpha = 1;
                };

                const drawGround = (particles, cx, by) => {
                    const time = Date.now();
                    const tilt = 0.25;
                    particles.forEach(p => {
                        const curAngle = p.angle + time * 0.0002;
                        const x = Math.cos(curAngle) * p.radius;
                        const z = Math.sin(curAngle) * p.radius;
                        const sx = cx + x;
                        const sy = by + z * tilt;
                        const scale = 1 + (z/800);
                        const alpha = 0.3 + (Math.sin(time*p.blinkSpeed + p.blinkOffset)+1)*0.3;
                        ctx.globalAlpha = Math.max(0, Math.min(1, alpha*scale));
                        ctx.fillStyle = p.color;
                        if(scale > 0.2) {
                            ctx.beginPath(); ctx.arc(sx, sy, p.size*scale, 0, Math.PI*2); ctx.fill();
                        }
                    });
                    ctx.globalAlpha = 1;
                };

                const drawTopper = (cx, cy, r, type, color) => {
                    const g = ctx.createRadialGradient(cx, cy, r*0.2, cx, cy, r*6);
                    g.addColorStop(0, "rgba(255,255,255,1)");
                    g.addColorStop(0.2, color==='#FFFFFF' ? "rgba(200,240,255,0.6)" : "rgba(255,105,180,0.6)");
                    g.addColorStop(1, "rgba(0,0,0,0)");
                    ctx.fillStyle = g;
                    ctx.beginPath(); ctx.arc(cx, cy, r*6, 0, Math.PI*2); ctx.fill();
                    
                    ctx.shadowBlur = 20; ctx.shadowColor = "#FFFFFF";
                    if(type === 'moon') {
                        ctx.beginPath(); ctx.arc(cx, cy, r, Math.PI*0.25, Math.PI*1.75, true);
                        ctx.arc(cx+r*0.3, cy, r*0.8, Math.PI*1.75, Math.PI*0.25, false);
                        ctx.fillStyle = "#FFFACD"; ctx.fill();
                    } else {
                        const s = r;
                        ctx.fillStyle = "#FFC0CB";
                        ctx.beginPath();
                        ctx.moveTo(cx, cy + s*0.2);
                        ctx.bezierCurveTo(cx - s/2, cy - s/2 - s*0.3, cx - s, cy + s/3, cx, cy + s);
                        ctx.bezierCurveTo(cx + s, cy + s/3, cx + s/2, cy - s/2 - s*0.3, cx, cy + s*0.2);
                        ctx.fill();
                    }
                    ctx.shadowBlur = 0;
                };

                let animationFrameId;
                const render = () => {
                    const time = Date.now();
                    const g = ctx.createLinearGradient(0,0,0,canvas.height);
                    g.addColorStop(0, '#000000'); g.addColorStop(0.5, '#050510'); g.addColorStop(1, '#0f0f20');
                    ctx.fillStyle = g; ctx.fillRect(0,0,canvas.width, canvas.height);
                    
                    const isMobile = canvas.width < 768;
                    const by = canvas.height * 0.85;
                    const tmH = isMobile ? canvas.height*0.6 : canvas.height*0.7;
                    const tmW = tmH * 0.7;
                    const lx = isMobile ? canvas.width*0.25 : canvas.width*0.3;
                    const rx = isMobile ? canvas.width*0.75 : canvas.width*0.7;

                    drawGround(leftGround, lx, by);
                    drawGround(rightGround, rx, by);
                    processTree(leftTree, lx, by, tmW, tmH);
                    processTree(rightTree, rx, by, tmW, tmH);
                    drawTopper(lx, by-tmH-5, 20, 'moon', '#FFFFFF');
                    drawTopper(rx, by-tmH-5, 20, 'heart', '#FF1493');

                    ctx.fillStyle = "#FFFFFF";
                    snow.forEach(s => {
                        s.y += s.vy; s.x += Math.sin(time*0.001 + s.y*0.01)*0.5;
                        if(s.y > canvas.height) { s.y = -10; s.x = Math.random()*canvas.width; }
                        ctx.globalAlpha = s.alpha; ctx.beginPath(); ctx.arc(s.x, s.y, s.radius, 0, Math.PI*2); ctx.fill();
                    });
                    ctx.globalAlpha = 1;
                    animationFrameId = requestAnimationFrame(render);
                };
                render();
                return () => cancelAnimationFrame(animationFrameId);
            }, [windowSize]);

            return (
                <div className="relative w-full h-full bg-black">
                    <canvas ref={canvasRef} className="block absolute top-0 left-0 w-full h-full z-0" />
                    <div className="absolute bottom-4 w-full z-10 flex flex-col items-center justify-center gap-1 text-white/30 text-xs font-mono select-none pointer-events-none">
                        <p>A.P</p>
                        <p className="opacity-75">M.C 2025</p>
                    </div>
                </div>
            );
        };

        // --- 4. INTRO SCENE COMPONENT ---
        const INTRO_TYPING_SPEED = 235; // speed
        const FINAL_TYPING_SPEED = 75; // speed

        const INTRO_MESSAGES = [
            'äº²çˆ±çš„, Merry Christmas!â„ï¸',
            'I hope this Christmas brings you everything your heart desires.ðŸ¤—',
            'May you get rich, be loved, and have good luck constantly with you all the way. ðŸ€',
            'For some things, I dont persist because I see hope; rather, it is only by persisting that I can see hope.',
            'One day, our paths will cross, and we will have a true chance to meet and connect.',
            'Im not sure what the future holds, but...',
            'Until then, take care of yourself and be happy.ðŸ˜Š',
            'æˆ–è®¸ä½ ä¸å†è®°å¾—æˆ‘ï¼Œä¸å†è®°å¾—å…³äºŽæˆ‘ä»¬ä¹‹é—´æ‰€æœ‰çš„æ‰€æœ‰.',
            'æ²¡å…³ç³»ï¼Œåªè¦ä½ å¹¸ç¦å°±è¶³å¤Ÿ.',
            'åŽ»è§ä½ æƒ³è§çš„äººï¼Œè¿‡ä½ æƒ³è¿‡çš„äººç”Ÿ.',
            'åˆ»ä¸‹çš„æ¯ä¸€é“æ³ªç—•ï¼Œéƒ½è®©ç”Ÿå‘½å˜å¾—æ›´å®Œæ•´ã€‚åŽ»çˆ±ä½ æ‰€çˆ±çš„äºº.',
            'æˆ‘æŒ¥éœäº†æ‰€æœ‰è¿æ°”ï¼Œåªä¸ºé‚£ä¸€åˆ»é‡è§ä½ ã€‚å†è§ä¼šæ˜¯æ›´å¥½çš„æˆ‘ä»¬.',
            'All the best. Have fun and enjoy the day season!ðŸŽ‰',
            '------',
            '                   From S.O iykyk',
        ];

        const FINAL_MESSAGES = [
        'Khi em má»Ÿ Ä‘Æ°á»£c lÃ¡ thÆ° nÃ y, thÃ¬ anh nghÄ© ráº±ng em Ä‘Ã£ hiá»ƒu táº¥t cáº£ nhá»¯ng Ä‘iá»u nÃ y lÃ  dÃ nh cho em rá»“i nhá»‰?',
            'Cáº£m Æ¡n em Ä‘Ã£ kiÃªn nháº«n vÃ  dÃ nh thá»i gian Ä‘á»ƒ cÃ³ thá»ƒ Ä‘á»c Ä‘áº¿n Ä‘Ã¢y.',
            'Hoáº·c lÃ  khÃ´ng...',
            'ThÃ¬ em sáº½ mÃ£i khÃ´ng biáº¿t Ä‘Æ°á»£c ráº±ng vÃ o ngÃ y hÃ´m nay, cÃ³ ngÆ°á»i chá»‰ muá»‘n tháº¯p sÃ¡ng cáº£ báº§u trá»i Ä‘á»ƒ em cáº£m nháº­n Ä‘Æ°á»£c sá»± vui váº» tá»« nÆ¡i xa...',
            'Hi vá»ng nÄƒm 19 tuá»•i, ngÃ y 25/12/2025 nÃ y em Ä‘Ã£ cÃ³ má»™t ngÃ y tháº­t háº¡nh phÃºc vÃ  Ä‘Ã¡ng nhá»›.',
            'Cáº£m Æ¡n em Ä‘Ã£ Ä‘áº¿n cÅ©ng nhÆ° biáº¿n máº¥t khá»i cuá»™c sá»‘ng cá»§a anh má»™t cÃ¡ch tá»­ táº¿.',
            'Máº·c dÃ¹ 52 ngÃ y trÆ°á»›c em Ä‘Ã£ báº£o lÃ  Ä‘á»«ng cÃ³ tá» tÃ¬nh ná»¯a nha...',
            'But, láº§n nÃ y sáº½ lÃ  láº§n tá» tÃ¬nh thá»© 3 cá»§a anh vÃ  sáº½ lÃ  láº§n Ä‘áº§u tiÃªn tá»± báº£n thÃ¢n anh nÃ³i cÃ¢u: "Anh thÃ­ch em" chá»© khÃ´ng pháº£i lÃ  em há»i - anh Ä‘Ã¡p láº¡i.',
            'Anh biáº¿t chÃºng ta cÃ³ nhiá»u khÃ¡c biá»‡t, anh cÅ©ng khÃ´ng biáº¿t gÃ¬ vá» em cáº£.',
            'ChÃºng ta chá»‰ nhÆ° 2 ngÆ°á»i láº¡ giao nhau má»™t Ä‘oáº¡n Ä‘Æ°á»ng tháº­t ngáº¯n rá»“i cá»© tháº¿ lÆ°á»›t qua nhau.',
            'Tuy nhiÃªn, anh nguyá»‡n dÃ nh Ä‘oáº¡n Ä‘Æ°á»ng dÃ i phÃ­a trÆ°á»›c, Ä‘á»©ng chá» em, chá»‰ Ä‘á»ƒ nÃ³i:',
            '"ChÃ o em! Anh cÃ³ thá»ƒ lÃ m quen em vÃ  thÃªm thÃ nh phá»‘ nÆ¡i em sá»‘ng thÃ nh Ä‘á»‹a Ä‘iá»ƒm tiáº¿p theo mÃ  anh sáº½ dá»«ng chÃ¢n khÃ´ng?',
            'Ngay tá»« khoáº£nh kháº¯c biáº¿t em, anh Ä‘Ã£ muá»‘n sau nÃ y Ä‘Æ°á»£c Ä‘á»©ng bÃªn cáº¡nh em rá»“i".',
            'Náº¿u nhÆ° thuáº­n lá»£i, anh sáº½ dÃ¹ng thá»i gian cÃ²n láº¡i Ä‘á»ƒ báº¯t Ä‘áº§u hiá»ƒu vá» em vÃ  Ä‘á»“ng hÃ nh cÃ¹ng em.',
            '"I hope even If I wasnt your first love, I intend to be your last, however long it takes"...',
            'Tuy nhiÃªn, Ä‘Ã³ chá»‰ lÃ  náº¿u nhÆ° anh Ä‘Æ°á»£c má»™t sá»± "gáº­t Ä‘áº§u" tá»« em.',
            'Hoáº·c náº¿u khÃ´ng...cÅ©ng khÃ´ng sao cáº£.',
            'Má»™t Ä‘oáº¡n Ä‘Æ°á»ng ngáº¯n nÃ y, mong em Ä‘Ã£ cÃ³ vÃ i khoáº£nh kháº¯c cáº£m tháº¥y vui váº».',
            'Anh váº«n luÃ´n tin ráº±ng khoáº£nh kháº¯c Ä‘áº¹p Ä‘áº½ nháº¥t sáº½ luÃ´n bÃªn cáº¡nh em...',
            'Again, chÃºc em tiá»n Ä‘á»“ tá»±a gáº¥m hoa - cÃ³ táº¥t cáº£ nhá»¯ng Ä‘iá»u em mong Æ°á»›c, thÃ nh cÃ´ng trÃªn con Ä‘Æ°á»ng mÃ  em chá»n, gáº·p Ä‘Æ°á»£c nhiá»u ngÆ°á»i yÃªu thÆ°Æ¡ng em vÃ  luÃ´n luÃ´n gáº·p may máº¯n trong má»i viá»‡c.',
            'Always & Forever!',
            'WYZDZ',
            '------',
            '"Náº¿u gáº·p tuyáº¿t ngá»«ng rÆ¡i, Ã¡nh trÄƒng Ä‘áº§y trá»i.',
            'Äáº¥t báº±ng tráº£i ra tráº¯ng xÃ³a.',
            'Máº·t Ä‘áº¥t trÃ´i, chuyá»ƒn thÃ nh Ã¡nh báº¡c.',
            'CÃ²n ngÆ°á»i má»‰m cÆ°á»i Ä‘i vá» phÃ­a tÃ´i.',
            'Giá»¯a Ã¡nh trÄƒng vÃ  Ã¡nh tuyáº¿t.',
            'ThÃ¬ "ngÆ°á»i" lÃ  tuyá»‡t sáº¯c thá»© ba."'
        ];

        const IntroScene = ({ mode, onComplete }) => {
            const [showIcon, setShowIcon] = useState(false);
            const [isOpen, setIsOpen] = useState(false);
            const [showVideoPlayer, setShowVideoPlayer] = useState(false);
            const [isUnlocked, setIsUnlocked] = useState(false);
            const [password, setPassword] = useState('');
            const [shake, setShake] = useState(false);
            const [currentLineIndex, setCurrentLineIndex] = useState(0);
            const [displayedLines, setDisplayedLines] = useState([]);
            const [currentTypingLine, setCurrentTypingLine] = useState('');
            const audioRef = useRef(null);
            
            const activeMessages = mode === 'password' ? FINAL_MESSAGES : INTRO_MESSAGES;

            useEffect(() => {
                if (mode === 'video') setShowIcon(true);
                else setTimeout(() => setShowIcon(true), 2500);
            }, [mode]);

            useEffect(() => {
                if (mode !== 'video' || !audioRef.current) return;
                if (isOpen && !showVideoPlayer) {
                    if (audioRef.current.paused) {
                        audioRef.current.volume = 0.7;
                        audioRef.current.play().catch(console.error);
                    }
                } else {
                    audioRef.current.pause();
                }
            }, [isOpen, showVideoPlayer, mode]);

            useEffect(() => {
                if (!isOpen) return;
                if (mode === 'video' && showVideoPlayer) return;
                if (mode === 'password' && !isUnlocked) return;

                if (currentLineIndex < activeMessages.length) {
                    const targetLine = activeMessages[currentLineIndex];
                    let charIndex = 0;
                    const speed = mode === 'video' ? INTRO_TYPING_SPEED : FINAL_TYPING_SPEED;
                    const interval = setInterval(() => {
                        charIndex++;
                        setCurrentTypingLine(targetLine.slice(0, charIndex));
                        if (charIndex === targetLine.length) {
                            clearInterval(interval);
                            setTimeout(() => {
                                setDisplayedLines(p => [...p, targetLine]);
                                setCurrentTypingLine('');
                                setCurrentLineIndex(p => p + 1);
                            }, speed * 3);
                        }
                    }, speed);
                    return () => clearInterval(interval);
                }
            }, [isOpen, isUnlocked, currentLineIndex, mode, showVideoPlayer]);

            const handleClose = () => {
                setIsOpen(false);
                if (mode === 'video' && onComplete) onComplete();
            };

            const handlePasswordChange = (e) => {
                const val = e.target.value;
                if (!/^\d*$/.test(val)) return;
                setPassword(val);
                setShake(false);
                if (val.length === 4) {
                    if (val === '0901') setIsUnlocked(true);
                    else {
                        setShake(true);
                        setTimeout(() => { setShake(false); setPassword(''); }, 500);
                    }
                }
            };

            return (
                <div className={`w-full h-full relative ${mode === 'video' ? 'bg-[url("https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExa3pwaHlwMzI5MXNqY2c4YjVwZDJzeW51NGd3MmMxMzQ3N2phcmY4YiZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/xT1XGvd5NCegc48wgw/giphy.gif")] bg-cover bg-center' : 'bg-transparent'}`}>
                    {mode === 'video' && <audio ref={audioRef} loop src="https://www.dropbox.com/scl/fi/3lq5v8hf1or4c2hj2f64n/.mp3?rlkey=7xupl7z0ys3xsnmrera36sg8l&st=spincinq&raw=1" />}
                    
                    {!isOpen && (
                        <div onClick={() => setIsOpen(true)} className={`absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 cursor-pointer pointer-events-auto hover:scale-110 transition-all duration-1000 ${showIcon ? 'opacity-100 translate-y-0' : 'opacity-0 translate-y-10'}`} title="For A.P">
                            {mode === 'video' ? (
                                <div className="w-48 h-32">
                                    <img src="https://media1.giphy.com/media/v1.Y2lkPTc5MGI3NjExZDUzMjlncnBnMGZudmZzaDRyY3g1anowNnRqY2F5bnBzOG04NzdtOSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/L9EUxgj4PCwU6pZXsS/giphy.gif" alt="mail" className="w-full h-full object-contain drop-shadow-[0_0_15px_rgba(255,255,255,0.5)]" />
                                </div>
                            ) : (
                                <div className="relative w-40 h-28 shadow-[0_0_30px_rgba(236,72,153,0.6)] group">
                                    <div className="absolute inset-0 bg-[#3b2d50] rounded-sm"></div>
                                    <div className="absolute top-2 left-2 right-2 h-20 bg-white transition-all duration-500 group-hover:-translate-y-6">
                                         <div className="w-full h-full p-2 flex flex-col gap-1">
                                             <div className="w-full h-0.5 bg-gray-300"></div>
                                             <div className="w-3/4 h-0.5 bg-gray-300"></div>
                                             <div className="w-1/2 h-0.5 bg-gray-300"></div>
                                         </div>
                                    </div>
                                    <div className="absolute bottom-0 left-0 right-0 border-l-[80px] border-r-[80px] border-b-[60px] border-l-transparent border-r-transparent border-b-[#5e4b7a] z-10"></div>
                                    <div className="absolute bottom-0 left-0 border-l-[80px] border-t-[56px] border-b-[56px] border-l-[#4d3a66] border-y-transparent z-10"></div>
                                    <div className="absolute bottom-0 right-0 border-r-[80px] border-t-[56px] border-b-[56px] border-r-[#4d3a66] border-y-transparent z-10"></div>
                                    <div className="absolute top-0 left-0 w-0 h-0 border-l-[80px] border-r-[80px] border-t-[60px] border-l-transparent border-r-transparent border-t-[#6b568c] z-20 origin-top transition-transform duration-500 group-hover:rotate-x-180"></div>
                                    <div className="absolute top-[40%] left-1/2 -translate-x-1/2 -translate-y-1/2 z-30 text-2xl drop-shadow-md group-hover:opacity-0 transition-opacity">ðŸ’Œ</div>
                                </div>
                            )}
                        </div>
                    )}

                    {isOpen && (
                        <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm pointer-events-auto">
                            <div className="relative bg-cover bg-center bg-[#261938] rounded-lg shadow-[0_0_30px_rgba(162,89,237,0.5)] max-w-lg w-full max-h-[90vh] p-8 text-[#3a295a] overflow-hidden">
                                <button onClick={handleClose} className="absolute top-2 right-4 text-3xl text-white/50 hover:text-white z-20">&times;</button>
                                
                                {/* Background Gif Logic: Show in Password mode, or in Video mode IF video is NOT playing */}
                                {(!showVideoPlayer) && (
                                     <div className="absolute inset-0 opacity-20 blur-sm z-0" style={{ backgroundImage: `url('https://media.giphy.com/media/v1.Y2lkPWVjZjA1ZTQ3d2dob2djamlmZzlqZWx2YnViZjhoa3NrY3Ric2prN2UzY2U4N29rdSZlcD12MV9naWZzX3NlYXJjaCZjdT1n/XQiJigZpYQ9dKrrEbv/giphy.gif')` }}></div>
                                )}
                                
                                <div className="relative z-10 w-full h-full flex flex-col items-center justify-center min-h-[250px] overflow-y-auto">
                                    {mode === 'video' ? (
                                        showVideoPlayer ? (
                                            <div className="w-full flex flex-col items-center animate-[fadeIn_1s_ease-out]">
                                                <video className="w-full rounded-md shadow-lg max-h-[60vh]" controls autoPlay onEnded={onComplete}>
                                                    <source src="https://www.dropbox.com/scl/fi/ibild9hqgw5jalh8adaow/For-Ang.mp4?rlkey=k1y57qvn5opccu8p5h6431opl&st=lgzp3iat&raw=1" type="video/mp4" />
                                                </video>
                                                <button onClick={() => onComplete && onComplete()} className="mt-6 text-white/50 hover:text-white text-sm underline">Skip &gt;&gt;</button>
                                            </div>
                                        ) : (
                                            <div className="flex flex-col items-start w-full h-full animate-[fadeIn_1s_ease-out] pt-4 overflow-y-auto max-h-[80vh] scrollbar-hide">
                                                <div className="flex flex-col gap-3 w-full text-white/90 text-sm md:text-base font-['Chiron_Sung_HK'] leading-relaxed pb-8">
                                                    {displayedLines.map((line, i) => <p key={i} className="animate-[fadeIn_0.5s_ease-out]">{line}</p>)}
                                                    {currentTypingLine && <p className="typing">{currentTypingLine}</p>}
                                                </div>
                                                {(displayedLines.length === activeMessages.length) && !currentTypingLine && (
                                                    <button onClick={() => setShowVideoPlayer(true)} className="mt-4 px-6 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-full font-bold shadow-lg hover:scale-105 transition-transform animate-[fadeIn_1s_ease-in]">A little something for Christmas ðŸŽ¬</button>
                                                )}
                                            </div>
                                        )
                                    ) : (
                                        !isUnlocked ? (
                                            <div className="flex flex-col items-center justify-center w-full animate-[fadeIn_0.5s_ease-out]">
                                               <h3 className="text-[#b476f5] font-['Chiron_Sung_HK'] text-xl mb-8 tracking-wider">Locked</h3>
                                               <div className={`relative ${shake ? 'animate-shake' : ''}`}>
                                                  <input type="password" maxLength={4} value={password} onChange={handlePasswordChange} className="text-center text-4xl tracking-[0.5em] bg-transparent border-b-2 border-[#b476f5] text-white w-48 outline-none focus:border-[#ca0c53] transition-colors font-mono py-2" autoFocus placeholder="____"/>
                                               </div>
                                               <p className="text-white/40 text-xs mt-6 font-['Chiron_Sung_HK']">Type your special day (B.D)</p>
                                            </div>
                                        ) : (
                                            <div className="flex flex-col items-start w-full h-full animate-[fadeIn_1s_ease-out] pt-4 overflow-y-auto max-h-[80vh] scrollbar-hide">
                                                <div className="flex flex-col gap-3 w-full text-white/90 text-sm md:text-base font-['Chiron_Sung_HK'] leading-relaxed pb-8">
                                                    {displayedLines.map((line, i) => <p key={i} className="animate-[fadeIn_0.5s_ease-out]">{line}</p>)}
                                                    {currentTypingLine && <p className="typing">{currentTypingLine}</p>}
                                                </div>
                                            </div>
                                        )
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // --- 5. APP COMPONENT ---
        const App = () => {
            const [stage, setStage] = useState('INTRO');
            const audioRef = useRef(null);

            useEffect(() => {
                if ((stage === 'DATE_REVEAL' || stage === 'MAIN') && audioRef.current) {
                    if (audioRef.current.paused) {
                        audioRef.current.volume = 0.8;
                        // Attempt play
                        audioRef.current.play().catch(console.warn);
                    }
                }
            }, [stage]);

            const handleIntroComplete = () => {
                // Ensure music starts exactly when transitioning
                if (audioRef.current) {
                    audioRef.current.volume = 0.8;
                    audioRef.current.currentTime = 0;
                    audioRef.current.play().catch(console.warn);
                }
                setStage('DATE_REVEAL');
            };

            return (
                <div className="w-screen h-screen overflow-hidden bg-black font-sans relative">
                    <SnowOverlay />
                    
                    {/* Persistent Audio 2 (using raw=1 for better streaming compatibility) */}
                    <audio id="date-audio" ref={audioRef} loop preload="auto" src="https://www.dropbox.com/scl/fi/a0ko7h8p9988r1epy9yge/Christmas-List.mp3?rlkey=nqrel0f2fnjgpit2i0qlpj5w3&st=5jqpt97w&raw=1" />
                    
                    {stage === 'INTRO' && <IntroScene mode="video" onComplete={handleIntroComplete} />}
                    {stage === 'DATE_REVEAL' && <DateReveal onComplete={() => setStage('MAIN')} />}
                    {stage === 'MAIN' && (
                        <div className="relative w-full h-full animate-[fadeIn_2s_ease-in]">
                             <ChristmasScene />
                             <div className="absolute inset-0 z-50 pointer-events-none">
                                <IntroScene mode="password" />
                             </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />); 
    </script>
</body>
</html>
